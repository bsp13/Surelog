
<!DOCTYPE html>
<html>
<head>
<style>
body {

}
p {
font-size: 14px;
}</style>
<h3>./bp_fe/src/v/bp_fe_icache.v Cov: 96.3% </h3>
<pre style="margin:0; padding:0 ">   1: /**</pre>
<pre style="margin:0; padding:0 ">   2:  *</pre>
<pre style="margin:0; padding:0 ">   3:  * Name:</pre>
<pre style="margin:0; padding:0 ">   4:  *   bp_fe_icache.v</pre>
<pre style="margin:0; padding:0 ">   5:  *</pre>
<pre style="margin:0; padding:0 ">   6:  * Description:</pre>
<pre style="margin:0; padding:0 ">   7:  *   To	be updated</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">   8:  * The icache module implements a virtually-indexed physically-tagged cache. Although the cache</pre>
<pre id="id9" style="background-color: #FFB6C1; margin:0; padding:0 ">   9:  * design is parameterized, our default icache configuration is a 4-way set associative cache. Our</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  10:  * icache has an LCE as part of the cache controller that communicates with the CCE. For replacement</pre>
<pre style="margin:0; padding:0 ">  11:  * policy, we use the pseudo-LRU module implemnted for dcache.</pre>
<pre style="margin:0; padding:0 ">  12:  *</pre>
<pre style="margin:0; padding:0 ">  13:  * Notes:</pre>
<pre style="margin:0; padding:0 ">  14:  *</pre>
<pre style="margin:0; padding:0 ">  15:  */</pre>
<pre style="margin:0; padding:0 ">  16: </pre>
<pre style="margin:0; padding:0 ">  17: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  18: module bp_fe_icache</pre>
<pre style="margin:0; padding:0 ">  19:   import bp_common_pkg::*;</pre>
<pre style="margin:0; padding:0 ">  20:   import bp_common_aviary_pkg::*;</pre>
<pre style="margin:0; padding:0 ">  21:   import bp_fe_pkg::*;</pre>
<pre style="margin:0; padding:0 ">  22:   import bp_fe_icache_pkg::*;  </pre>
<pre style="margin:0; padding:0 ">  23:   #(parameter bp_cfg_e cfg_p = e_bp_inv_cfg</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  24:    `declare_bp_proc_params(cfg_p)</pre>
<pre style="margin:0; padding:0 ">  25:    `declare_bp_lce_cce_if_widths(num_cce_p, num_lce_p, paddr_width_p, lce_assoc_p, dword_width_p, cce_block_width_p)</pre>
<pre style="margin:0; padding:0 ">  26:     `declare_bp_fe_tag_widths(lce_assoc_p, lce_sets_p, num_lce_p, num_cce_p, dword_width_p, paddr_width_p)</pre>
<pre style="margin:0; padding:0 ">  27:     `declare_bp_icache_widths(vaddr_width_p, tag_width_lp, lce_assoc_p) </pre>
<pre style="margin:0; padding:0 ">  28: </pre>
<pre style="margin:0; padding:0 ">  29:     , parameter debug_p=0</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  30:     )</pre>
<pre style="margin:0; padding:0 ">  31:    (input                                              clk_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  32:     , input                                            reset_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  33:     , input                                            freeze_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  34: </pre>
<pre style="margin:0; padding:0 ">  35:     , input [lce_id_width_lp-1:0]                      lce_id_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  36: </pre>
<pre style="margin:0; padding:0 ">  37:     // Config channel</pre>
<pre style="margin:0; padding:0 ">  38:     , input                                            cfg_w_v_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  39:     , input [cfg_addr_width_p-1:0]                     cfg_addr_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  40:     , input [cfg_data_width_p-1:0]                     cfg_data_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  41: </pre>
<pre style="margin:0; padding:0 ">  42:     , input [vaddr_width_p-1:0]                        vaddr_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  43:     , input                                            vaddr_v_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  44:     , output                                           vaddr_ready_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  45: </pre>
<pre style="margin:0; padding:0 ">  46:     , input [ptag_width_p-1:0]                         ptag_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  47:     , input                                            ptag_v_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  48:     , input                                            uncached_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  49:     , input                                            poison_tl_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  50:     </pre>
<pre style="margin:0; padding:0 ">  51:     , output [instr_width_p-1:0]                       data_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  52:     , output                                           data_v_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  53:     , output                                           instr_access_fault_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  54:     , output                                           cache_miss_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  55: </pre>
<pre style="margin:0; padding:0 ">  56:     , output [lce_cce_req_width_lp-1:0]                lce_req_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  57:     , output                                           lce_req_v_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  58:     , input                                            lce_req_ready_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  59: </pre>
<pre style="margin:0; padding:0 ">  60:     , output [lce_cce_resp_width_lp-1:0]               lce_resp_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  61:     , output                                           lce_resp_v_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  62:     , input                                            lce_resp_ready_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  63: </pre>
<pre style="margin:0; padding:0 ">  64:     , input [lce_cmd_width_lp-1:0]                     lce_cmd_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  65:     , input                                            lce_cmd_v_i</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  66:     , output                                           lce_cmd_ready_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  67: </pre>
<pre style="margin:0; padding:0 ">  68:     , output [lce_cmd_width_lp-1:0]                    lce_cmd_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  69:     , output                                           lce_cmd_v_o</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  70:     , input                                            lce_cmd_ready_i </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  71:  );</pre>
<pre style="margin:0; padding:0 ">  72: </pre>
<pre style="margin:0; padding:0 ">  73:   logic [index_width_lp-1:0]            vaddr_index;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  74: </pre>
<pre style="margin:0; padding:0 ">  75:   logic [word_offset_width_lp-1:0] vaddr_offset;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  76: </pre>
<pre style="margin:0; padding:0 ">  77:   logic [lce_assoc_p-1:0]               way_v; // valid bits of each way</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  78:   logic [way_id_width_lp-1:0]           way_invalid_index; // first invalid way</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  79:   logic                                 invalid_exist;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  80: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  81:   logic                                 invalidate_cmd_v; // an invalidate command from CCE</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  82: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  83:   assign vaddr_index      = vaddr_i[word_offset_width_lp</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  84:                                        +byte_offset_width_lp</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  85:                                        +:index_width_lp];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  86:   assign vaddr_offset     = vaddr_i[byte_offset_width_lp+:word_offset_width_lp];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  87:    </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  88:   // TL stage</pre>
<pre style="margin:0; padding:0 ">  89:   logic v_tl_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  90:   logic tl_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  91:   logic [bp_page_offset_width_gp-1:0] page_offset_tl_r;</pre>
<pre style="margin:0; padding:0 ">  92:   logic [vaddr_width_p-1:0]           vaddr_tl_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  93: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  94:   assign tl_we = vaddr_v_i; </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  95: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  96:   always_ff @ (posedge clk_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  97:     if (reset_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  98:       v_tl_r       <= 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  99:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 100:       v_tl_r       <= tl_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 101:       if (tl_we) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 102:         page_offset_tl_r <= vaddr_i[bp_page_offset_width_gp-1:0];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 103:         vaddr_tl_r       <= vaddr_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 104:       end</pre>
<pre style="margin:0; padding:0 "> 105:     end</pre>
<pre style="margin:0; padding:0 "> 106:   end</pre>
<pre style="margin:0; padding:0 "> 107: </pre>
<pre style="margin:0; padding:0 "> 108:   // tag memory</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 109:   logic                                     tag_mem_v_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 110:   logic                                     tag_mem_w_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 111:   logic [index_width_lp-1:0]                tag_mem_addr_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 112:   logic [lce_assoc_p-1:0][`bp_coh_bits+tag_width_lp-1:0] tag_mem_data_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 113:   logic [lce_assoc_p-1:0][`bp_coh_bits+tag_width_lp-1:0] tag_mem_w_mask_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 114:   logic [lce_assoc_p-1:0][`bp_coh_bits+tag_width_lp-1:0] tag_mem_data_lo;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 115: </pre>
<pre style="margin:0; padding:0 "> 116:   bsg_mem_1rw_sync_mask_write_bit #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 117:     .width_p(lce_assoc_p*(`bp_coh_bits+tag_width_lp))</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 118:     ,.els_p(lce_sets_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 119:   ) tag_mem (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 120:     .clk_i(clk_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 121:     ,.reset_i(reset_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 122:     ,.data_i(tag_mem_data_li)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 123:     ,.addr_i(tag_mem_addr_li)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 124:     ,.v_i(~reset_i & tag_mem_v_li)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 125:     ,.w_mask_i(tag_mem_w_mask_li)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 126:     ,.w_i(tag_mem_w_li)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 127:     ,.data_o(tag_mem_data_lo)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 128:   );</pre>
<pre id="id129" style="background-color: #FFB6C1; margin:0; padding:0 "> 129: </pre>
<pre style="margin:0; padding:0 "> 130:   logic [lce_assoc_p-1:0][`bp_coh_bits-1:0] state_tl;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 131:   logic [lce_assoc_p-1:0][tag_width_lp-1:0] tag_tl;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 132: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 133:   for (genvar i = 0; i < lce_assoc_p; i++) begin</pre>
<pre style="margin:0; padding:0 "> 134:     assign state_tl[i] = tag_mem_data_lo[i][tag_width_lp+:`bp_coh_bits];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 135:     assign tag_tl[i]   = tag_mem_data_lo[i][0+:tag_width_lp];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 136:   end</pre>
<pre style="margin:0; padding:0 "> 137: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 138:   // data memory</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 139:   logic [lce_assoc_p-1:0]                                           data_mem_v_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 140:   logic                                                             data_mem_w_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 141:   logic [lce_assoc_p-1:0][index_width_lp+word_offset_width_lp-1:0]  data_mem_addr_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 142:   logic [lce_assoc_p-1:0][dword_width_p-1:0]                        data_mem_data_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 143:   logic [lce_assoc_p-1:0][data_mask_width_lp-1:0]                   data_mem_w_mask_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 144:   logic [lce_assoc_p-1:0][dword_width_p-1:0]                        data_mem_data_lo;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 145: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 146:   // data memory: banks</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 147:   for (genvar bank = 0; bank < lce_assoc_p; bank++)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 148:   begin: data_mems</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 149:     bsg_mem_1rw_sync_mask_write_byte #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 150:       .data_width_p(dword_width_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 151:       ,.els_p(lce_sets_p*lce_assoc_p) // same number of blocks and ways</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 152:     ) data_mem (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 153:       .clk_i(clk_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 154:       ,.reset_i(reset_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 155:       ,.data_i(data_mem_data_li[bank])</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 156:       ,.addr_i(data_mem_addr_li[bank])</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 157:       ,.v_i(~reset_i & data_mem_v_li[bank])</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 158:       ,.write_mask_i(data_mem_w_mask_li[bank])</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 159:       ,.w_i(data_mem_w_li)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 160:       ,.data_o(data_mem_data_lo[bank])</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 161:     );</pre>
<pre style="margin:0; padding:0 "> 162:   end                                             </pre>
<pre style="margin:0; padding:0 "> 163: </pre>
<pre style="margin:0; padding:0 "> 164:   // TV stage</pre>
<pre style="margin:0; padding:0 "> 165:   logic v_tv_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 166:   logic tv_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 167:   logic uncached_tv_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 168:   logic [paddr_width_p-1:0]                     addr_tv_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 169:   logic [vaddr_width_p-1:0]                     vaddr_tv_r; </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 170:   logic [lce_assoc_p-1:0][tag_width_lp-1:0]     tag_tv_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 171:   logic [lce_assoc_p-1:0][`bp_coh_bits-1:0]     state_tv_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 172:   logic [lce_assoc_p-1:0][dword_width_p-1:0]    ld_data_tv_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 173:   logic [tag_width_lp-1:0]                      addr_tag_tv;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 174:   logic [index_width_lp-1:0]                    addr_index_tv;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 175:   logic [word_offset_width_lp-1:0]              addr_word_offset_tv;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 176: </pre>
<pre style="margin:0; padding:0 "> 177:   assign tv_we = v_tl_r & ~poison_tl_i & ptag_v_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 178: </pre>
<pre style="margin:0; padding:0 "> 179:   always_ff @ (posedge clk_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 180:     if (reset_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 181:       v_tv_r       <= 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 182:     end</pre>
<pre style="margin:0; padding:0 "> 183:     else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 184:       v_tv_r <= tv_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 185:       if (tv_we) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 186:         addr_tv_r    <= {ptag_i, vaddr_tl_r[0+:bp_page_offset_width_gp]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 187:         vaddr_tv_r   <= vaddr_tl_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 188:         tag_tv_r     <= tag_tl;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 189:         state_tv_r   <= state_tl;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 190:         ld_data_tv_r <= data_mem_data_lo;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 191:         uncached_tv_r <= uncached_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 192:       end</pre>
<pre style="margin:0; padding:0 "> 193:     end</pre>
<pre style="margin:0; padding:0 "> 194:   end</pre>
<pre style="margin:0; padding:0 "> 195: </pre>
<pre style="margin:0; padding:0 "> 196:   assign addr_tag_tv = addr_tv_r[block_offset_width_lp+index_width_lp+:tag_width_lp];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 197:   assign addr_index_tv = addr_tv_r[block_offset_width_lp+:index_width_lp];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 198:   assign addr_word_offset_tv = addr_tv_r[byte_offset_width_lp+:word_offset_width_lp];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 199: </pre>
<pre style="margin:0; padding:0 "> 200:   //cache hit?</pre>
<pre style="margin:0; padding:0 "> 201:   logic [lce_assoc_p-1:0]     hit_v;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 202:   logic [way_id_width_lp-1:0] hit_index;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 203:   logic                       hit;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 204:   logic                       miss_tv;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 205: </pre>
<pre style="margin:0; padding:0 "> 206:   for (genvar i = 0; i < lce_assoc_p; i++) begin: tag_comp</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 207:     assign hit_v[i]   = (tag_tv_r[i] == addr_tag_tv) && (state_tv_r[i] != e_COH_I);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 208:     assign way_v[i]   = (state_tv_r[i] != e_COH_I);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 209:   end</pre>
<pre style="margin:0; padding:0 "> 210: </pre>
<pre style="margin:0; padding:0 "> 211:   bsg_priority_encode #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 212:     .width_p(lce_assoc_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 213:     ,.lo_to_hi_p(1)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 214:   ) pe_load_hit (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 215:     .i(hit_v)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 216:     ,.v_o(hit)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 217:     ,.addr_o(hit_index)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 218:   );</pre>
<pre style="margin:0; padding:0 "> 219: </pre>
<pre style="margin:0; padding:0 "> 220:   assign miss_tv = ~hit & v_tv_r & ~uncached_tv_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 221: </pre>
<pre style="margin:0; padding:0 "> 222:   // uncached request</pre>
<pre style="margin:0; padding:0 "> 223:   logic uncached_req;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 224:   logic uncached_load_data_v_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 225:   logic [dword_width_p-1:0] uncached_load_data_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 226: </pre>
<pre style="margin:0; padding:0 "> 227:   assign uncached_req = v_tv_r & uncached_tv_r & ~uncached_load_data_v_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 228: </pre>
<pre style="margin:0; padding:0 "> 229:   // stat memory</pre>
<pre style="margin:0; padding:0 "> 230:   logic                                       stat_mem_v_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 231:   logic                                       stat_mem_w_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 232:   logic [index_width_lp-1:0]                  stat_mem_addr_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 233:   logic [bp_fe_icache_stat_width_lp-1:0]      stat_mem_data_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 234:   logic [bp_fe_icache_stat_width_lp-1:0]      stat_mem_mask_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 235:   logic [bp_fe_icache_stat_width_lp-1:0]      stat_mem_data_lo;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 236: </pre>
<pre style="margin:0; padding:0 "> 237:   bsg_mem_1rw_sync_mask_write_bit #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 238:     .width_p(bp_fe_icache_stat_width_lp)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 239:     ,.els_p(lce_sets_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 240:   ) stat_mem (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 241:     .clk_i(clk_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 242:     ,.reset_i(reset_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 243:     ,.data_i(stat_mem_data_li)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 244:     ,.addr_i(stat_mem_addr_li)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 245:     ,.v_i(~reset_i & stat_mem_v_li)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 246:     ,.w_mask_i(stat_mem_mask_li)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 247:     ,.w_i(stat_mem_w_li)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 248:     ,.data_o(stat_mem_data_lo)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 249:   );</pre>
<pre style="margin:0; padding:0 "> 250: </pre>
<pre style="margin:0; padding:0 "> 251:   logic [way_id_width_lp-1:0] lru_encode;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 252: </pre>
<pre style="margin:0; padding:0 "> 253:   bsg_lru_pseudo_tree_encode #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 254:     .ways_p(lce_assoc_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 255:   ) lru_encoder (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 256:     .lru_i(stat_mem_data_lo)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 257:     ,.way_id_o(lru_encode)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 258:   );</pre>
<pre style="margin:0; padding:0 "> 259: </pre>
<pre style="margin:0; padding:0 "> 260:   bsg_priority_encode #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 261:     .width_p(lce_assoc_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 262:     ,.lo_to_hi_p(1)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 263:   ) pe_invalid (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 264:     .i(~way_v)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 265:     ,.v_o(invalid_exist)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 266:     ,.addr_o(way_invalid_index)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 267:  );</pre>
<pre style="margin:0; padding:0 "> 268:   </pre>
<pre style="margin:0; padding:0 "> 269:   // invalid way takes priority over LRU way</pre>
<pre style="margin:0; padding:0 "> 270:   logic [way_id_width_lp-1:0]           lru_way_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 271:   assign lru_way_li = invalid_exist ? way_invalid_index : lru_encode;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 272: </pre>
<pre style="margin:0; padding:0 "> 273:   // LCE</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 274:   `declare_bp_fe_icache_lce_data_mem_pkt_s(lce_sets_p, lce_assoc_p, lce_data_width_lp);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 275:   `declare_bp_fe_icache_lce_tag_mem_pkt_s(lce_sets_p, lce_assoc_p, tag_width_lp);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 276:   `declare_bp_fe_icache_lce_stat_mem_pkt_s(lce_sets_p, lce_assoc_p);</pre>
<pre style="margin:0; padding:0 "> 277: </pre>
<pre style="margin:0; padding:0 "> 278:   bp_fe_icache_lce_data_mem_pkt_s lce_data_mem_pkt;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 279:   bp_fe_icache_lce_tag_mem_pkt_s tag_mem_pkt;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 280:   bp_fe_icache_lce_stat_mem_pkt_s stat_mem_pkt;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 281: </pre>
<pre style="margin:0; padding:0 "> 282:   logic [lce_assoc_p-1:0][dword_width_p-1:0] lce_data_mem_data_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 283:   logic                                      lce_data_mem_pkt_v_lo;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 284:   logic                                      lce_data_mem_pkt_yumi_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 285: </pre>
<pre style="margin:0; padding:0 "> 286:   logic                                      tag_mem_pkt_v_lo;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 287:   logic                                      tag_mem_pkt_yumi_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 288: </pre>
<pre style="margin:0; padding:0 "> 289:   logic                                      stat_mem_pkt_v_lo;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 290:   logic                                      stat_mem_pkt_yumi_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 291: </pre>
<pre style="margin:0; padding:0 "> 292:   bp_fe_icache_lce_mode_e lce_mode_lo;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 293: </pre>
<pre style="margin:0; padding:0 "> 294:   bp_fe_lce</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 295:     #(.cfg_p(cfg_p))</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 296:   lce</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 297:     (.clk_i(clk_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 298:      ,.reset_i(reset_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 299:      ,.freeze_i(freeze_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 300: </pre>
<pre style="margin:0; padding:0 "> 301:      ,.cfg_w_v_i(cfg_w_v_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 302:      ,.cfg_addr_i(cfg_addr_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 303:      ,.cfg_data_i(cfg_data_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 304: </pre>
<pre id="id305" style="background-color: #FFB6C1; margin:0; padding:0 "> 305:      ,.lce_id_i(lce_id_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 306: </pre>
<pre id="id307" style="background-color: #FFB6C1; margin:0; padding:0 "> 307:      ,.ready_o(vaddr_ready_o)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 308:      ,.cache_miss_o(cache_miss_o)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 309: </pre>
<pre style="margin:0; padding:0 "> 310:      ,.miss_i(miss_tv)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 311:      ,.miss_addr_i(addr_tv_r)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 312: </pre>
<pre id="id313" style="background-color: #FFB6C1; margin:0; padding:0 "> 313:      ,.uncached_req_i(uncached_req)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 314: </pre>
<pre style="margin:0; padding:0 "> 315:      ,.data_mem_data_i(lce_data_mem_data_li)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 316:      ,.data_mem_pkt_o(lce_data_mem_pkt)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 317:      ,.data_mem_pkt_v_o(lce_data_mem_pkt_v_lo)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 318:      ,.data_mem_pkt_yumi_i(lce_data_mem_pkt_yumi_li)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 319: </pre>
<pre style="margin:0; padding:0 "> 320:      ,.tag_mem_pkt_o(tag_mem_pkt)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 321:      ,.tag_mem_pkt_v_o(tag_mem_pkt_v_lo)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 322:      ,.tag_mem_pkt_yumi_i(tag_mem_pkt_yumi_li)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 323: </pre>
<pre id="id324" style="background-color: #FFB6C1; margin:0; padding:0 "> 324:      ,.stat_mem_pkt_v_o(stat_mem_pkt_v_lo)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 325:      ,.stat_mem_pkt_o(stat_mem_pkt)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 326:      ,.lru_way_i(lru_way_li)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 327:      ,.stat_mem_pkt_yumi_i(stat_mem_pkt_yumi_li)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 328: </pre>
<pre style="margin:0; padding:0 "> 329:      ,.lce_req_o(lce_req_o)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 330:      ,.lce_req_v_o(lce_req_v_o)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 331:      ,.lce_req_ready_i(lce_req_ready_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 332: </pre>
<pre style="margin:0; padding:0 "> 333:      ,.lce_resp_o(lce_resp_o)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 334:      ,.lce_resp_v_o(lce_resp_v_o)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 335:      ,.lce_resp_ready_i(lce_resp_ready_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 336: </pre>
<pre style="margin:0; padding:0 "> 337:      ,.lce_cmd_i(lce_cmd_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 338:      ,.lce_cmd_v_i(lce_cmd_v_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 339:      ,.lce_cmd_ready_o(lce_cmd_ready_o)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 340: </pre>
<pre style="margin:0; padding:0 "> 341:      ,.lce_cmd_o(lce_cmd_o)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 342:      ,.lce_cmd_v_o(lce_cmd_v_o)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 343:      ,.lce_cmd_ready_i(lce_cmd_ready_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 344: </pre>
<pre style="margin:0; padding:0 "> 345:      ,.lce_mode_o(lce_mode_lo)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 346:      ); </pre>
<pre style="margin:0; padding:0 "> 347: </pre>
<pre style="margin:0; padding:0 "> 348:   // Fault if in uncached mode but access is not for an uncached address</pre>
<pre style="margin:0; padding:0 "> 349:   assign instr_access_fault_o = (lce_mode_lo == e_icache_lce_mode_uncached)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 350:     ? ~uncached_tv_r</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 351:     : 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 352: </pre>
<pre style="margin:0; padding:0 "> 353:   assign data_v_o = v_tv_r & ((uncached_tv_r & uncached_load_data_v_r) | ~cache_miss_o);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 354: </pre>
<pre style="margin:0; padding:0 "> 355:   logic [dword_width_p-1:0]   ld_data_way_picked;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 356: </pre>
<pre style="margin:0; padding:0 "> 357:   bsg_mux #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 358:     .width_p(dword_width_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 359:     ,.els_p(lce_assoc_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 360:   ) data_set_select_mux (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 361:     .data_i(ld_data_tv_r)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 362:     ,.sel_i(hit_index ^ addr_word_offset_tv)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 363:     ,.data_o(ld_data_way_picked)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 364:   );</pre>
<pre style="margin:0; padding:0 "> 365: </pre>
<pre style="margin:0; padding:0 "> 366:   logic [dword_width_p-1:0] final_data;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 367:   bsg_mux #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 368:     .width_p(dword_width_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 369:     ,.els_p(2)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 370:   ) final_data_mux (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 371:     .data_i({uncached_load_data_r, ld_data_way_picked})</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 372:     ,.sel_i(uncached_load_data_v_r)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 373:     ,.data_o(final_data)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 374:   );</pre>
<pre style="margin:0; padding:0 "> 375: </pre>
<pre style="margin:0; padding:0 "> 376:   logic lower_upper_sel;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 377: </pre>
<pre style="margin:0; padding:0 "> 378:   assign lower_upper_sel             = addr_tv_r[byte_offset_width_lp-1];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 379:   assign data_o = lower_upper_sel</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 380:     ? final_data[instr_width_p+:instr_width_p]</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 381:     : final_data[instr_width_p-1:0];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 382: </pre>
<pre style="margin:0; padding:0 "> 383:   // data mem</pre>
<pre style="margin:0; padding:0 "> 384: </pre>
<pre style="margin:0; padding:0 "> 385:   logic lce_data_mem_v;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 386:   assign lce_data_mem_v = (lce_data_mem_pkt.opcode != e_icache_lce_data_mem_uncached)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 387:     & lce_data_mem_pkt_yumi_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 388: </pre>
<pre style="margin:0; padding:0 "> 389:   assign data_mem_v_li = tl_we</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 390:     ? {lce_assoc_p{1'b1}}</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 391:     : {lce_assoc_p{lce_data_mem_v}};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 392: </pre>
<pre style="margin:0; padding:0 "> 393:   assign data_mem_w_li = lce_data_mem_pkt_yumi_li</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 394:     & (lce_data_mem_pkt.opcode == e_icache_lce_data_mem_write);   </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 395: </pre>
<pre style="margin:0; padding:0 "> 396:   logic [lce_assoc_p-1:0][dword_width_p-1:0] lce_data_mem_write_data;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 397: </pre>
<pre style="margin:0; padding:0 "> 398:   for (genvar i = 0; i < lce_assoc_p; i++) begin</pre>
<pre style="margin:0; padding:0 "> 399:     assign data_mem_addr_li[i] = tl_we</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 400:       ? {vaddr_index, vaddr_offset}</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 401:       : {lce_data_mem_pkt.index, lce_data_mem_pkt.way_id ^ ((word_offset_width_lp)'(i))};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 402: </pre>
<pre style="margin:0; padding:0 "> 403:     assign data_mem_data_li[i] = lce_data_mem_write_data[i];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 404:     assign data_mem_w_mask_li[i] = {data_mask_width_lp{1'b1}};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 405:   end</pre>
<pre style="margin:0; padding:0 "> 406: </pre>
<pre style="margin:0; padding:0 "> 407:   bsg_mux_butterfly #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 408:     .width_p(dword_width_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 409:     ,.els_p(lce_assoc_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 410:   ) write_mux_butterfly (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 411:     .data_i(lce_data_mem_pkt.data)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 412:     ,.sel_i(lce_data_mem_pkt.way_id)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 413:     ,.data_o(lce_data_mem_write_data)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 414:   );</pre>
<pre style="margin:0; padding:0 "> 415:    </pre>
<pre style="margin:0; padding:0 "> 416:   // tag_mem</pre>
<pre style="margin:0; padding:0 "> 417:   assign tag_mem_v_li = tl_we | tag_mem_pkt_yumi_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 418:   assign tag_mem_w_li = ~tl_we & tag_mem_pkt_v_lo;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 419:   assign tag_mem_addr_li = tl_we</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 420:     ? vaddr_index</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 421:     : tag_mem_pkt.index;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 422: </pre>
<pre style="margin:0; padding:0 "> 423:   logic [lce_assoc_p-1:0] lce_tag_mem_way_one_hot;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 424:   bsg_decode #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 425:     .num_out_p(lce_assoc_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 426:   ) lce_tag_mem_way_decode (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 427:     .i(tag_mem_pkt.way_id)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 428:     ,.o(lce_tag_mem_way_one_hot)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 429:   );</pre>
<pre style="margin:0; padding:0 "> 430: </pre>
<pre style="margin:0; padding:0 "> 431:   always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 432:     case (tag_mem_pkt.opcode)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 433:       e_tag_mem_set_clear: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 434:         for (integer i = 0 ; i < lce_assoc_p; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 435:           tag_mem_data_li[i]    = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 436:           tag_mem_w_mask_li[i]  = {(`bp_coh_bits+tag_width_lp){1'b1}};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 437:         end</pre>
<pre style="margin:0; padding:0 "> 438:       end</pre>
<pre style="margin:0; padding:0 "> 439:       e_tag_mem_invalidate: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 440:         for (integer i = 0; i < lce_assoc_p; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 441:           tag_mem_data_li[i]    = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 442:           tag_mem_w_mask_li[i] = {{`bp_coh_bits{lce_tag_mem_way_one_hot[i]}}, {tag_width_lp{1'b0}}};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 443:         end</pre>
<pre style="margin:0; padding:0 "> 444:       end</pre>
<pre style="margin:0; padding:0 "> 445:       e_tag_mem_set_tag: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 446:         for (integer i = 0; i < lce_assoc_p; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 447:           tag_mem_data_li[i]   = {tag_mem_pkt.state, tag_mem_pkt.tag};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 448:           tag_mem_w_mask_li[i] = {(`bp_coh_bits+tag_width_lp){lce_tag_mem_way_one_hot[i]}};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 449:         end</pre>
<pre style="margin:0; padding:0 "> 450:       end</pre>
<pre style="margin:0; padding:0 "> 451:       default: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 452:         tag_mem_data_li   = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 453:         tag_mem_w_mask_li = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 454:       end</pre>
<pre style="margin:0; padding:0 "> 455:     endcase</pre>
<pre style="margin:0; padding:0 "> 456:   end</pre>
<pre style="margin:0; padding:0 "> 457: </pre>
<pre style="margin:0; padding:0 "> 458:   // stat mem</pre>
<pre style="margin:0; padding:0 "> 459:   assign stat_mem_v_li = (v_tv_r & ~uncached_tv_r) | stat_mem_pkt_yumi_li;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 460:   assign stat_mem_w_li = v_tv_r</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 461:     ? ~miss_tv</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 462:     : stat_mem_pkt_yumi_li & (stat_mem_pkt.opcode != e_stat_mem_read);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 463:   assign stat_mem_addr_li = v_tv_r</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 464:     ? addr_index_tv </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 465:     : stat_mem_pkt.index;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 466: </pre>
<pre style="margin:0; padding:0 "> 467:   logic [lce_assoc_p-2:0] lru_decode_data_lo;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 468:   logic [lce_assoc_p-2:0] lru_decode_mask_lo;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 469: </pre>
<pre style="margin:0; padding:0 "> 470:   bsg_lru_pseudo_tree_decode #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 471:      .ways_p(lce_assoc_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 472:   ) lru_decode (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 473:      .way_id_i(hit_index)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 474:      ,.data_o(lru_decode_data_lo)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 475:      ,.mask_o(lru_decode_mask_lo)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 476:   );</pre>
<pre style="margin:0; padding:0 "> 477: </pre>
<pre style="margin:0; padding:0 "> 478:   always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 479:     if (v_tv_r) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 480:       stat_mem_data_li = lru_decode_data_lo;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 481:       stat_mem_mask_li = lru_decode_mask_lo;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 482:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 483:       stat_mem_data_li = {(lce_assoc_p-1){1'b0}};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 484:       stat_mem_mask_li = {(lce_assoc_p-1){1'b1}};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 485:     end</pre>
<pre style="margin:0; padding:0 "> 486:   end</pre>
<pre style="margin:0; padding:0 "> 487:    </pre>
<pre style="margin:0; padding:0 "> 488:   // LCE: data mem</pre>
<pre style="margin:0; padding:0 "> 489:   logic [way_id_width_lp-1:0] lce_data_mem_pkt_way_r;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 490: </pre>
<pre style="margin:0; padding:0 "> 491:   always_ff @ (posedge clk_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 492:     if (lce_data_mem_pkt_yumi_li & (lce_data_mem_pkt.opcode == e_icache_lce_data_mem_read)) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 493:       lce_data_mem_pkt_way_r <= lce_data_mem_pkt.way_id;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 494:     end</pre>
<pre style="margin:0; padding:0 "> 495:   end</pre>
<pre style="margin:0; padding:0 "> 496: </pre>
<pre style="margin:0; padding:0 "> 497:   bsg_mux_butterfly #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 498:     .width_p(dword_width_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 499:     ,.els_p(lce_assoc_p)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 500:   ) read_mux_butterfly (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 501:     .data_i(data_mem_data_lo)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 502:     ,.sel_i(lce_data_mem_pkt_way_r)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 503:     ,.data_o(lce_data_mem_data_li)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 504:   );</pre>
<pre style="margin:0; padding:0 "> 505: </pre>
<pre style="margin:0; padding:0 "> 506:   assign lce_data_mem_pkt_yumi_li = (lce_data_mem_pkt.opcode == e_icache_lce_data_mem_uncached)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 507:     ? lce_data_mem_pkt_v_lo</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 508:     : lce_data_mem_pkt_v_lo & ~tl_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 509: </pre>
<pre style="margin:0; padding:0 "> 510:   // uncached load data logic</pre>
<pre style="margin:0; padding:0 "> 511:   always_ff @(posedge clk_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 512:     if (reset_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 513:       uncached_load_data_v_r <= 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 514:     end</pre>
<pre style="margin:0; padding:0 "> 515:     else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 516:       if (lce_data_mem_pkt_yumi_li & (lce_data_mem_pkt.opcode == e_icache_lce_data_mem_uncached)) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 517:         uncached_load_data_r <= lce_data_mem_pkt.data[0+:dword_width_p];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 518:         uncached_load_data_v_r <= 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 519:       end</pre>
<pre style="margin:0; padding:0 "> 520:       else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 521:         // once the uncached load is replayed, and v_o goes high, clear the valid bit</pre>
<pre style="margin:0; padding:0 "> 522:         if (data_v_o) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 523:           uncached_load_data_v_r <= 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 524:         end</pre>
<pre style="margin:0; padding:0 "> 525:       end</pre>
<pre style="margin:0; padding:0 "> 526:     end</pre>
<pre style="margin:0; padding:0 "> 527:   end</pre>
<pre style="margin:0; padding:0 "> 528: </pre>
<pre style="margin:0; padding:0 "> 529:   // LCE: tag_mem</pre>
<pre style="margin:0; padding:0 "> 530:   assign tag_mem_pkt_yumi_li = tag_mem_pkt_v_lo & ~tl_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 531: </pre>
<pre style="margin:0; padding:0 "> 532:   // LCE: stat_mem</pre>
<pre style="margin:0; padding:0 "> 533:   assign stat_mem_pkt_yumi_li = ~(v_tv_r & ~uncached_tv_r) & stat_mem_pkt_v_lo;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 534: </pre>
<pre style="margin:0; padding:0 "> 535:   // synopsys translate_off</pre>
<pre style="margin:0; padding:0 "> 536:   if (debug_p) begin</pre>
<pre style="margin:0; padding:0 "> 537:     bp_fe_icache_axe_trace_gen #(</pre>
<pre id="id538" style="background-color: #FFB6C1; margin:0; padding:0 "> 538:       .addr_width_p(paddr_width_p)</pre>
<pre id="id539" style="background-color: #FFB6C1; margin:0; padding:0 "> 539:       ,.dword_width_p(instr_width_p)</pre>
<pre id="id540" style="background-color: #FFB6C1; margin:0; padding:0 "> 540:     ) cc (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 541:       .clk_i(clk_i)</pre>
<pre id="id542" style="background-color: #FFB6C1; margin:0; padding:0 "> 542:       ,.id_i(lce_id_i)</pre>
<pre id="id543" style="background-color: #FFB6C1; margin:0; padding:0 "> 543:       ,.v_i(icache_pc_gen_data_v_o)</pre>
<pre id="id544" style="background-color: #FFB6C1; margin:0; padding:0 "> 544:       ,.addr_i(addr_tv_r)</pre>
<pre id="id545" style="background-color: #FFB6C1; margin:0; padding:0 "> 545:       ,.data_i(data_o)</pre>
<pre id="id546" style="background-color: #FFB6C1; margin:0; padding:0 "> 546:     );</pre>
<pre style="margin:0; padding:0 "> 547:   end</pre>
<pre style="margin:0; padding:0 "> 548:   // synopsys translate_on</pre>
<pre style="margin:0; padding:0 "> 549:    </pre>
<pre style="margin:0; padding:0 "> 550: endmodule</pre>
<pre style="margin:0; padding:0 "> 551: </pre>
</body>
</html>
